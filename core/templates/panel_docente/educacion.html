{% extends 'panel_docente/dashboard_base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/educacion_docente.css' %}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Choices.js estilos -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
{% endblock %}

{% block panel_content %}
<div class="container-fluid px-0" style="max-width: 1000px; margin: 0 auto;">
  <div class="card glass-container">

    <!-- Banner -->
    <div class="banner-img">
      <img src="{% static 'img/banner_docente.jpg' %}" alt="Banner Educación Docente">
    </div>

    <div class="card-body">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
        <h1 class="educacion-title mb-3 mb-md-0">
          <i class="bi bi-mortarboard me-2"></i> Educación Académica
        </h1>
        <button type="button" class="btn-agregar" data-bs-toggle="modal" data-bs-target="#modalEducacion">
          <i class="bi bi-plus-circle me-1"></i> Agregar Educación
        </button>
      </div>

      <!-- Mensajes -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show glass-alert" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Lista de Educación -->
      {% if educaciones %}
        <div class="row g-4">
          {% for educacion in educaciones %}
            <div class="col-12 d-flex">
              <div class="card glass-card h-100 w-100">
                <div class="card-header glass-card-header">
                  <h5 class="mb-0">
                    <i class="bi bi-mortarboard me-1"></i> {{ educacion.nivel }}
                  </h5>
                </div>
                <div class="card-body">
                  <h6 class="text-white-50 mb-2">{{ educacion.institucion }}</h6>
                  <p><strong>Título:</strong> {{ educacion.titulo_obtenido }}</p>
                  <p class="mb-0">
                    <i class="bi bi-calendar me-1"></i>
                    {{ educacion.fecha_inicio|date:"M Y" }} - {{ educacion.fecha_fin|date:"M Y" }}
                  </p>
                </div>
                <div class="card-footer bg-transparent border-0">
                  <div class="btn-group">
                    <a href="{% url 'editar_educacion' educacion.id %}" class="btn-editar">
                      <i class="bi bi-pencil"></i> Editar
                    </a>
                    <button type="button" class="btn-eliminar" onclick="eliminarEducacion('{{ educacion.id }}')">
                      <i class="bi bi-trash"></i> Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-mortarboard display-1 text-muted"></i>
          <h4 class="text-white-50 mt-3">No hay registros de educación</h4>
          <p class="text-white-50">Comienza agregando tu formación académica.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal para agregar educación -->
<div class="modal fade" id="modalEducacion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content glass-modal">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle me-1"></i> Agregar Educación
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.nivel.label_tag }}
              <!-- 🔑 Forzamos clases para que Choices.js y estilos se apliquen sí o sí -->
              {{ form.nivel|add_class:"form-select js-choice" }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.institucion.label_tag }}
              {{ form.institucion|add_class:"form-control" }}
            </div>
          </div>
          <div class="mb-3">
            {{ form.titulo_obtenido.label_tag }}
            {{ form.titulo_obtenido|add_class:"form-control" }}
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              {{ form.fecha_inicio.label_tag }}
              {{ form.fecha_inicio|add_class:"form-control" }}
            </div>
            <div class="col-md-6 mb-3">
              {{ form.fecha_fin.label_tag }}
              {{ form.fecha_fin|add_class:"form-control" }}
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancelar" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn-guardar">
            <i class="bi bi-check-circle"></i> Guardar Educación
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  <!-- Choices.js script -->
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script>
    // Inicializa Choices en TODOS los selects marcados con .js-choice
    function initChoices(scope) {
      const selects = (scope || document).querySelectorAll('select.js-choice');
      selects.forEach(sel => {
        if (!sel.dataset.choicesInit) {
          new Choices(sel, {
            searchEnabled: false,
            itemSelectText: '',
            shouldSort: false
          });
          sel.dataset.choicesInit = '1';
        }
      });
    }

    // Inicializamos al cargar y cuando se abre el modal (por si el DOM cambia)
    document.addEventListener('DOMContentLoaded', function () {
      initChoices(document);
    });

    const modalEl = document.getElementById('modalEducacion');
    if (modalEl) {
      modalEl.addEventListener('shown.bs.modal', function () {
        initChoices(modalEl);
      });
    }

    // Eliminar educación (igual que antes)
    function getCSRFToken() {
      const input = document.querySelector('input[name=csrfmiddlewaretoken]');
      if (input) return input.value;
      const match = document.cookie.match(/csrftoken=([^;]+)/);
      return match ? match[1] : '';
    }
    function eliminarEducacion(id) {
      if (!id) { alert('ID inválido'); return; }
      if (!confirm('¿Estás seguro de que quieres eliminar esta educación?')) return;

      fetch(`/docente/educacion/eliminar/${encodeURIComponent(id)}/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRFToken() },
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + (data.message || 'No se pudo eliminar'));
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error al eliminar la educación');
      });
    }
  </script>
{% endblock %}
